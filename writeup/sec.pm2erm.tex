\section{Integration of Plate Models and Entity Relationship Models}

\subsection{Translation of Plate Models to Entity Relationship Models}

In this section we propose a technique to transform a given directed graphical model in plate notation into a well-formed database model. This is done in three steps:
\begin{enumerate}
\item Transform multidimensional variables into their components. The resulting model is called an atomic plate model (APM).
\item\label{itm:apm2erm} Convert the APM into an ERM.
\item Reduce the ERM to avoid translation artifacts.
\end{enumerate}
The translation of APMs to ERMs is based on the mapping from plate models to directed acyclic probabilistic entity-relationship (DAPER) models proposed by \textcite{heckerman2007probabilistic}. Although the authors showed that the mapping is possible for every plate model, they did not go into detail about the concrete form of the resulting DAPER models / ERMs. If the mapping is applied directly to arbitrary plate models, the resulting ERMs are often not well-formed.\footnote{Converting plate models containing multidimensional variables directly leads to database models containing non-atomic attributes or having implicit relationships by adding foreign key attributes. [TODO: explain better, mb example or separate section?]}

We extend the translation procedure by converting the plate model into an APM first, then map the APM to an ERM, and reduce the ERM afterwards. Applying this extended procedure produces well-formed ERMs. The following sections offer detailed explanations for all steps.

\subsubsection{Atomic Plate Models}

Plate models may contain multidimensional variables, such as vectors or matrices. To receive an APM, multidimensional variables are split into their components such that there is one variable for each component. A plate containing an indexed component variable represents the multidimensional variable in the APM. Figure~\ref{fig:pm2apm} shows the conversion of plate models containing a vector and a matrix variable, respectively. The multidimensional variables $\vec x$ and $X$ are converted into individual component variables $x_n$ and $x_{nm}$, surrounded by plates of the corresponding dimensionality.

\begin{figure}[t]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/apm_vectors.tex}}
\caption{Conversion of plate models containing multidimensional variables to atomic plate models by modeling the components as individual variables. Subfigure (a) shows the conversion of an $|N|$ dimensional vector variable $\vec x$ to its components $x_n$. In (b), the $|N| \times |M|$ matrix $X$ is converted into a variable inside two plates, one for each dimension. Arrows are removed because they do not express conditional distributions anymore.}\label{fig:pm2apm}
\end{figure}


Multidimensional variables are often used as parameters for conditional probability distributions.\footnote{Consider the parameter $\vec \mu$ of a multinomial distribution that contains the probability for each possible outcome or the covariance matrix $\Sigma$ of a multivariate gaussian distribution.} In that case one cannot decompose those variables without losing the relationship between their components concerning the generative process of the model. However, it is not necessary to preserve this relationship in the conversion process to a database model as it will not be used as a generative model anymore. We thus leave out all the arrows after the conversion process to explicitly state that they may not represent conditional probability distributions in the APM.

\begin{Example} Atomic plate model creation for Dirichlet multinomial text clustering

Figure~\ref{fig:clustering_platemodels} illustrates the conversion procedure on the plate model for Dirichlet multinomial text clustering (see Example~\ref{ex:clustering-pm}, page~\pageref{ex:clustering-pm}). The $|V|$ dimensional vocabulary domain Words of the vector variables $\vec d_{nm}$, $\vec \mu_k$ and $\vec \beta_k$ is now made explicit and the Clusters plate is extended to the $|K|$ dimensional vector variables $\vec z_n$, $\vec \pi$ and $\vec \alpha$.

\begin{figure}[h!]
\begin{minipage}[t]{0.49\linewidth}
	\begin{center}
		\subfloat[Original clustering plate model]{\label{fig:clustering_platemodel_original}
    	\scalebox{\tikzScale}{\adjustTikzSize \input{img/clustering_transformation_platemodel.tex}}}
	\end{center}
\end{minipage}
\hspace{0.0cm}
\begin{minipage}[t]{0.49\linewidth}
	\begin{center}
		\subfloat[Atomic clustering plate model]{\label{fig:clustering_platemodel_expanded}
		\scalebox{\tikzScale}{\adjustTikzSize \input{img/clustering_transformation_platemodel_expanded.tex}}}
	\end{center}
\end{minipage}\\
\caption{Transformation of the plate model for Dirichlet multinomial text clustering to the corresponding APM. The Words plate represents the $|V|$ dimensional vocabulary domain of $\vec d_{nm}$, $\vec \mu_k$ and $\vec \beta_k$. The Clusters plate is extended to $\vec z_n$, $\vec \pi$ and $\vec \alpha$.}
\label{fig:clustering_platemodels}
\end{figure}

\end{Example}

\subsubsection{Translation of Atomic Plate Models to Entitiy Relationship Models}

\textcite{heckerman2007probabilistic} proposed a mapping from plate models to DAPER models. DAPER models are essentially ERMs that may contain probabilistic dependencies between attributes of entity classes. They can be expanded to a directed graphical model given a skeleton\footnote{A skeleton of an ERM is a specification of the entity and relationship classes associated with a specific database.}.

We adopt this mapping to produce ERMs instead of DAPER models by leaving out the probabilistic dependencies between attributes during the translation process. Additionally we show some special cases of model constraints and their influence on the resulting ERM. The mapping is as follows:

\begin{description}
\item[Translate plates to entity types.] Each plate is represented as an entity type. Usually there is an index set associated with each plate. The cardinality of this set states how many entities of the given type will be present in the database. Each entity type gets an artificial key (ID). Figure~\ref{fig:pm2erm_uno_local} illustrates the translation of a plate representing $n$ Objects to the Object entity type.

\begin{figure}[t]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/pm2erm_uno_local.tex}}
\caption{Conversion of a plate containing a variable $x_n$ to an entity type having an artificial key ID and an attribute $x$.}\label{fig:pm2erm_uno_local}
\end{figure}

\item[Translate plate intersections to relationships.] In general, plate intersections represent many to many relationships between the corresponding entity types. In contrast to the original mapping we express all relationships as association entities (\cite[p.~86-88]{elmasri2007database}). This allows a generic translation procedure that can easily be used for n-ary relationships. Figure~\ref{fig:pm2erm_bi_noconstraints} shows the translation of two entity types having a binary relationship.

\begin{figure}[t]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/pm2erm_bi_noconstraints.tex}}
\caption{Conversion of a plate intersection to an association entity of a many to many relationship. The variable $z_{nm}$ residing in the intersection is represented as the attribute $z$ of the association entity.}\label{fig:pm2erm_bi_noconstraints}
\end{figure}

\item[Translate variables to attributes.] Variables will be translated to attributes of either entity types or relationships, depending on the number of plates surrounding them. If a variable is surrounded by exactly one plate, the entity type of that plate gets an additional attribute representing this variable (see Figure~\ref{fig:pm2erm_uno_local}). If a variable lies inside multiple plates, it becomes an attribute of the corresponding association entity (see Figure~\ref{fig:pm2erm_bi_noconstraints}). Variables that are associated with no plate are assigned to an artificial entity type called Global (see Figure~\ref{fig:pm2erm_uno_global}). As Global does not have a primary key, there is only one entity. [TODO: are entity types w/o keys possible?]

\begin{figure}[p]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/pm2erm_uno_global.tex}}
\caption{Conversion of a single variable that is not located in any plate. It will be associated with an artificial entity type called Global.}\label{fig:pm2erm_uno_global}
\end{figure}

\item[Translate nested plates to one to many relationships.] If a plate is nested in another plate, the resulting relationship has a one to many cardinality instead of many to many. For each entity from the covering plate there may exist many covered entities. We adjust this mapping rule to the concept of association entity types as demonstrated in Figure~\ref{fig:pm2erm_covered_1}. If a plate covers another plate, it will not have a weak relationship to the association entity type.\footnote{In case of binary relationships like in Figure~\ref{fig:pm2erm_covered_1} this will result in a malformed ERM. A weak entity with only one weak relationship is simply an extension of the original entity. It will be merged in the reduction step (see Section~\ref{sec:erm_reduction}).} It then does no longer extend the key of the association entity.
\end{description}

In addition to the above rules we propose two additional transformation rules that define the effect of variable contraints on the resulting ERM and cope with self relationships as a result of matrix or tensor variable translation:

\begin{description}
\item[Adjust cardinalities depending on variable constraints.] In some applications there are variables that solely express probabilistic or uncertain relationships. Those are often coded as multidimensional binary variables whose components follow certain summation constraints. \textcite{bishop2006pattern} refers to this as the 1-of-K coding scheme.

Given a binary variable that is bound to an association entity and a constraint that requires it to sum to one over either index set of the surrounding plates, this affects the cardinality of the resulting relationship in the same way that nested plates do. The entity type which is summed over will not have a weak relationship to the association entity. The attribute of the association entity is then removed.

In case of two overlapping plates this yields a malformed\footnote{Like in Figure~\ref{fig:pm2erm_covered_1} this malformed relationship is merged in the reduction step.} one to many relationship like shown in Figure~\ref{fig:pm2erm_bi_constraints}. It correctly expresses the fact that a given instance of B is only connected to one instance of A, while a given instance of A may be connected to many Bs.

\item[Translate overlapping plates with same index set to self relationships.] When converting plate models with matrix or tensor variables to APMs, the translation procedure will produce overlapping plates as illustrated in Figure~\ref{fig:pm2apm}b. Given a matrix with equal dimensions $N = M$, this will result in two overlapping plates of the same index set. These are simply translated as a many to many self relationships. The matrix components are then represented as an attribute of the resulting association entity.
\end{description}

\begin{figure}[p]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/pm2erm_covered_1.tex}}
\caption{Conversion of nested plates to an association entity. One instance of  The entity type of the covering plate will have no weak relationship to the association entity. That reflects the fact that every instance of B does belong to exactly one instance of A.}\label{fig:pm2erm_covered_1}
\end{figure}

\begin{figure}[p]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/pm2erm_bi_constraints.tex}}
\caption{Conversion of a plate intersection to an association entity given a 1-of-K relationship variable constraint ($z_{nm}$). The contraint ensures that every instance of B can only be connected to one instance of A. Instead of representing this variable directly, it will affect the cardinality of the resulting relationship. The entity type which index set is summed over will not have a weak relationship to the association entity.}\label{fig:pm2erm_bi_constraints}
\end{figure}

With this set of rules it is possible to translate any given plate model into an ERM. However in some cases the resulting model might not be well-formed. It might express simple one to many relationships in a complicated way or even contain modeling errors like weak entitites that do not extend the primary key.

\begin{Example} Translation of the Dirichlet multinomial text clustering APM to a verbose ERM

Figure~\ref{fig:clustering_erm_good_verbose} shows the result of applying the translation rules to the text clustering APM from Figure~\ref{fig:clustering_platemodel_expanded}. The variables $\vec d$ and $\vec z$ are 1-of-K coded and affect the relationship Word---D-T-W and Cluster---Document, respectively. The Document---D-T-W relationship is not weak because the Token plate is nested. It is easily seen that there are degenerated cases of one to many relationships. In the next section we describe how to reduce such ERMs to obtain syntactically correct and well-formed ones.

\end{Example}

\begin{figure}[h]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/clustering_erm_good_verbose.tex}}
\caption{Verbose Dirichlet multinomial text clustering ERM, translated from an APM.}\label{fig:clustering_erm_good_verbose}
\end{figure}

\subsubsection{Reduction of Translated Entity Relationship Models}
\label{sec:erm_reduction}

In order to produce well-formed ERMs from plate models it is necessary to apply a reduction step on the resulting ERM of the plate model to APM conversion. This reduction will make sure that all artifacts which may result by applying the rules described in the previous section are eliminated. Those artifacts are (1) weak entities with only one weak relationship and (2) duplicate relationships.

Weak entities with only one weak relationship may occur in cases like shown in Figure~\ref{fig:pm2erm_covered_1} and \ref{fig:pm2erm_bi_constraints}. Plate intersections are translated to association entities having a weak relationship to all entities that form the intersection. However, 1-of-K coded variables and nested plates change weak relationships to normal ones. If all but one weak relationship gets changed, the construct is not well-formed because the weak entity does not extend a primary key. The weak relationship is then simply a 1:1 relationship and both entities can be merged.

After merging all entities like described above there may be duplicate relationships. Consider the case in Figure~\ref{fig:erm_reduction_minimal_example} where the two relationships between A and B become redundant after merging the three entities A-B-C, B and A-B-D. There will be a practical example of this situation in the case study in Section~\ref{sec:casestudy}. Note that this merging is only possible if the relationships are really expressing the same thing. [TODO: ask Alex about merging conditions.]

\begin{figure}[t]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/erm_reduction_minimal_example.tex}}
\caption{Merging two relationships after reducing malformed weak relationships.}\label{fig:erm_reduction_minimal_example}
\end{figure}

\begin{Example}{Reduced ERM for Dirichlet multinomial text clustering}

Figure~\ref{fig:clustering_erm_good_reduced} illustrates the result of reducing the ERM for Dirichlet multinomial text clustering from Figure~\ref{fig:clustering_erm_good_verbose}. The Token entity type is merged with D-T-W and Document with the D-C association entity.

\begin{figure}[h]
\centering
\scalebox{\tikzScale}{\adjustTikzSize \input{img/clustering_erm_good_reduced.tex}}
\caption{Reduced Dirichlet multinomial text clustering ERM.}\label{fig:clustering_erm_good_reduced}
\end{figure}

The resulting ERM is well-formed and expresses the data model of Dirichlet multinomial text clustering that one would expect. Documents consist of one or more tokens. A token belongs to one word type and there may be one or more tokens of one type. Documents are assigned to clusters and one cluster may have multiple documents assigned. The cluster distribution is expressed in Cluster.$\pi$ and Cluster.$\alpha$. The word distribution of each cluster is expressed in C-W.$\mu$ and C-W.$\beta$, respectively.

\end{Example}

\subsection{Matching Data Models and Translated Entity Relationship Models}

Given a set of probabilistic models the user selects a suiting model by matching the translated ERM templates of the probabilistic models with his problem specific data model. The set of probabilistic models and their ERM translation is provided by the framework. It can either be matched on ERM or relational model basis. A mapping from ERMs to relational models is described by \textcite{elmasri2007database}, p.~218-224.

In order to enable different applications of the probabilistic models (e.g., not only text clustering but also document clustering or clustering of supermarket customers), the ERM templates need to be generic. Instead of using domain specific terms like \emph{document}, \emph{word} and \emph{token} one should use generic ones like \emph{entity}, \emph{feature} and \emph{occurrence}. Depending on the use case a feature can then be a word or a product for document and customer clustering, respectively.

After matching both models the user receives an integrated model containing domain specific constructs enriched by constructs from the probabilistic model. The framework then selects an inference algorithm implementation, uses the provided data and calculates the results. The results are included in the joined database and can be used for further analysis.

\begin{Example} Matching a text data model with the Dirichlet multinomial clustering model

[TODO]

\end{Example}
